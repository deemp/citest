name: Main CI workflow

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  test-matrix:
    runs-on: ubuntu-22.04
    env:
      make-target: "nix-build"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1

      - name: Install Nix
        uses: nixbuild/nix-quick-install-action@v28

      - name: Restore and cache Nix store
        uses: nix-community/cache-nix-action@v5.2.0
        id: restore
        with:
          # restore and save a cache using this key
          primary-key: similar-cache-individual-${{ env.make-target }}-${{ hashFiles('.github/workflows/main.yml') }}
          # if there's no cache hit, restore a cache by this prefix
          # ignore for now
          # paths: |
          #   deps
          #   _build

      - name: Setup dependencies
        run: |
          nix develop -c mix deps.get

      - name: Run make target
        run: |
          nix build
          
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
