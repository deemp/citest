name: Main CI workflow

on:
  workflow_dispatch:
  push:
  pull_request:

env:
  make-target: "nix-build"

jobs:
  make-cache:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1

      - name: Install Nix
        uses: nixbuild/nix-quick-install-action@v28

      - name: Restore and cache Nix store
        uses: nix-community/cache-nix-action@v5.2.1
        with:
          primary-key: similar-cache-individual-${{ hashFiles('.github/workflows/main.yml') }}
          purge: true
          # purge all versions of the cache
          purge-prefixes: similar-cache-individual-
          # created more than this number of seconds ago relative to the start of the `Post Restore` phase
          purge-created: 0
          # except the version with the `primary-key`, if it exists
          purge-primary-key: never

      - name: Configure git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
            
      - name: List /nix before success
        run: |
          tree -a /nix > nix.txt
          git add nix.txt
          git commit -m "before success"
          git push
        
      - name: Build
        run: nix build
        
      - name: List /nix after success
        run: |
          tree -a /nix > nix.txt
          git add nix.txt
          git commit -m "after success"
          git push

  check-cache:
    runs-on: ubuntu-22.04
    needs: [ "make-cache" ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1

      - name: Change a file
        run: printf "\n\n" >> lib/citest.ex

      - name: Install Nix
        uses: nixbuild/nix-quick-install-action@v28

      - name: Restore and cache Nix store
        uses: nix-community/cache-nix-action@v5.2.1
        with:
          primary-key: similar-cache-individual-${{ hashFiles('.github/workflows/main.yml') }}
        
      - name: Configure git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
      
      - name: Pull changes
        run: git pull
          
      - name: List /nix before failure
        run: |
          tree -a /nix > nix.txt
          git add nix.txt
          git commit -m "before failure"
          git push
          
      - name: Build
        run: nix build
        
      - name: List /nix after failure
        if: always()
        run: |
          tree -a /nix > nix.txt
          git add nix.txt
          git commit -m "after failure"
          git push

      - name: Setup tmate session
        if: always()
        uses: mxschmitt/action-tmate@v3
