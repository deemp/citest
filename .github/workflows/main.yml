name: Main CI workflow

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  test-matrix:
    runs-on: ubuntu-22.04
    env:
      make-target: "nix-build"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1

      - name: Install Nix
        uses: nixbuild/nix-quick-install-action@v28

      - name: Restore and cache Nix store
        uses: nix-community/cache-nix-action@v5.2.0
        id: restore
        with:
          primary-key: similar-cache-individual-${{ env.make-target }}-${{ hashFiles('.github/workflows/main.yml') }}

      - name: Run make target
        run: nix build
          
      - name: Setup tmate session
        if: always()
        uses: mxschmitt/action-tmate@v3
